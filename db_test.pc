#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlda.h>
#include <sqlca.h>

EXEC SQL INCLUDE sqlca;

/* [전역 호스트 변수 선언] */
EXEC SQL BEGIN DECLARE SECTION;
    char *user_id = "system/Password123!@127.0.0.1:1521/xepdb1";
    char acc_no[20];
    char trans_type[20]; /* 한글 '입금/출금'을 담을 새 변수 추가 */
    VARCHAR user_name[20];
    long current_balance;
    long amount;
EXEC SQL END DECLARE SECTION;

/* 에러 핸들링 함수 */
void sql_error(char *msg) {
    printf("\n[치명적 오류] %s\n", msg);
    printf("SQL Code: %d\n", sqlca.sqlcode);
    printf("Message: %.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
    EXEC SQL ROLLBACK WORK RELEASE;
    exit(1);
}

/* 1. 계좌 로그인 함수 */
int login() {
    printf("\n작업할 계좌번호를 입력하세요 (예: 110-123-456): ");
    scanf("%s", acc_no);

    EXEC SQL SELECT USER_NAME INTO :user_name FROM ACCOUNT WHERE ACC_NO = :acc_no;

    if (sqlca.sqlcode == 1403) {
        printf("[실패] 등록되지 않은 계좌번호입니다.\n");
        return 0;
    } else if (sqlca.sqlcode != 0) {
        printf("[오류] DB 조회 중 에러 발생 (Code: %d)\n", sqlca.sqlcode);
        return 0;
    }

    user_name.arr[user_name.len] = '\0';
    printf("\n[환영합니다] %s 고객님, 인증되었습니다.\n", user_name.arr);
    return 1;
}

/* 2. 잔액 조회 함수 */
void check_balance() {
    EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        printf("\n[잔액조회] %s 고객님의 현재 잔액은 %ld원 입니다.\n", user_name.arr, current_balance);
    } else {
        printf("\n[오류] 계좌 정보를 찾을 수 없습니다.\n");
    }
}

/* 3. 입금 함수 (+ 거래내역 저장) */
void do_deposit() {
    printf("\n입금하실 금액을 입력하세요: ");
    scanf("%ld", &amount);
    
    if (amount <= 0) {
        printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
        return;
    }

    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE + :amount WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        /* 한글 리터럴 대신 변수 사용 */
        strcpy(trans_type, "입금");
        EXEC SQL INSERT INTO TRANSACTION_HISTORY (ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:acc_no, :trans_type, :amount);
        
        if (sqlca.sqlcode == 0) {
            EXEC SQL COMMIT;
            printf("[성공] %ld원이 입금되었습니다. (거래내역 저장 완료)\n", amount);
        } else {
            EXEC SQL ROLLBACK;
            printf("[오류] 거래내역 저장 실패 (Code: %d)\n", sqlca.sqlcode);
        }
    } else {
        EXEC SQL ROLLBACK;
        printf("[오류] 입금 처리 실패.\n");
    }
}

/* 4. 출금 함수 (+ 거래내역 저장) */
void do_withdraw() {
    printf("\n출금하실 금액을 입력하세요: ");
    scanf("%ld", &amount);

    if (amount <= 0) {
        printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
        return;
    }

    EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
    
    if (current_balance < amount) {
        printf("[실패] 잔액이 부족합니다. (현재 잔액: %ld원)\n", current_balance);
        return;
    }

    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE - :amount WHERE ACC_NO = :acc_no;
    
    if (sqlca.sqlcode == 0) {
        /* 한글 리터럴 대신 변수 사용 */
        strcpy(trans_type, "출금");
        EXEC SQL INSERT INTO TRANSACTION_HISTORY (ACC_NO, TRANS_TYPE, AMOUNT) VALUES (:acc_no, :trans_type, :amount);

        if (sqlca.sqlcode == 0) {
            EXEC SQL COMMIT;
            printf("[성공] %ld원이 정상적으로 출금되었습니다. (거래내역 저장 완료)\n", amount);
        } else {
            EXEC SQL ROLLBACK;
            printf("[오류] 거래내역 저장 실패 (Code: %d)\n", sqlca.sqlcode);
        }
    } else {
        EXEC SQL ROLLBACK;
        printf("[오류] 출금 처리 실패.\n");
    }
}

/* ================= 메인 함수 ================= */
int main() {
    putenv("NLS_LANG=KOREAN_KOREA.AL32UTF8");
    int choice;

    printf("1. 시스템 부팅 중...\n");

    EXEC SQL CONNECT :user_id;
    if (sqlca.sqlcode < 0) sql_error("DB 연결 실패!");
    printf("2. 오라클 DB 연결 성공!\n");

    while(!login()) {
        printf("다시 시도해주세요.\n");
    }

    while(1) {
        printf("\n========== C-STOCK ATM ==========\n");
        printf(" 1. 잔액조회   2. 입금   3. 출금   4. 종료\n");
        printf("=================================\n");
        printf("메뉴를 선택하세요: ");
        scanf("%d", &choice);

        if (choice == 4) {
            printf("\n이용해 주셔서 감사합니다. 시스템을 종료합니다.\n");
            break;
        }

        switch(choice) {
            case 1: check_balance(); break;
            case 2: do_deposit(); break;
            case 3: do_withdraw(); break;
            default: printf("\n[경고] 잘못된 메뉴를 선택하셨습니다. (1~4 입력)\n");
        }
    }

    EXEC SQL COMMIT WORK RELEASE;
    return 0;
}