#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlda.h>
#include <sqlca.h>

EXEC SQL INCLUDE sqlca;

void sql_error(char *msg) {
    printf("\n%s\n", msg);
    printf("SQL 에러 코드: %d\n", sqlca.sqlcode);
    printf("에러 메시지: %.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
    EXEC SQL ROLLBACK WORK RELEASE;
    exit(1);
}

int main() {
    putenv("NLS_LANG=KOREAN_KOREA.AL32UTF8");

    EXEC SQL BEGIN DECLARE SECTION;
        char *user_id = "system/Password123!@127.0.0.1:1521/xepdb1";
        char acc_no[20];
        VARCHAR user_name[20];
        long current_balance;
        long amount;
    EXEC SQL END DECLARE SECTION;

    int choice;

    printf("1. 프로그램 시작...\n");

    EXEC SQL CONNECT :user_id;
    if (sqlca.sqlcode < 0) sql_error("DB 연결 실패!");
    printf("2. 오라클 DB 연결 성공!\n");

    strcpy(acc_no, "110-123-456");

    /* 무한 루프 시작 (ATM 메뉴) */
    while(1) {
        printf("\n========== C-STOCK ATM ==========\n");
        printf(" 1. 잔액조회   2. 입금   3. 출금   4. 종료\n");
        printf("=================================\n");
        printf("메뉴를 선택하세요: ");
        scanf("%d", &choice);

        if (choice == 4) {
            printf("\n이용해 주셔서 감사합니다. 프로그램을 종료합니다.\n");
            break; // 루프 탈출
        }

        switch(choice) {
            case 1: // 잔액 조회
                /* 여러 줄이었던 쿼리를 한 줄로 수정 */
                EXEC SQL SELECT USER_NAME, BALANCE INTO :user_name, :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
                
                if (sqlca.sqlcode == 0) {
                    user_name.arr[user_name.len] = '\0';
                    printf("\n[잔액조회] %s 고객님의 현재 잔액은 %ld원 입니다.\n", user_name.arr, current_balance);
                } else {
                    printf("\n[오류] 계좌 정보를 찾을 수 없습니다.\n");
                }
                break;

            case 2: // 입금
                printf("\n입금하실 금액을 입력하세요: ");
                scanf("%ld", &amount);
                
                if (amount <= 0) {
                    printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
                    break;
                }

                /* 한 줄로 수정 */
                EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE + :amount WHERE ACC_NO = :acc_no;
                
                if (sqlca.sqlcode == 0) {
                    EXEC SQL COMMIT;
                    printf("[성공] %ld원이 입금되었습니다.\n", amount);
                } else {
                    EXEC SQL ROLLBACK;
                    printf("[오류] 입금 실패.\n");
                }
                break;

            case 3: // 출금
                printf("\n출금하실 금액을 입력하세요: ");
                scanf("%ld", &amount);

                if (amount <= 0) {
                    printf("[경고] 0원보다 큰 금액을 입력해야 합니다.\n");
                    break;
                }

                EXEC SQL SELECT BALANCE INTO :current_balance FROM ACCOUNT WHERE ACC_NO = :acc_no;
                
                if (current_balance < amount) {
                    printf("[실패] 잔액이 부족합니다. (현재 잔액: %ld원)\n", current_balance);
                } else {
                    /* 한 줄로 수정 */
                    EXEC SQL UPDATE ACCOUNT SET BALANCE = BALANCE - :amount WHERE ACC_NO = :acc_no;
                    
                    if (sqlca.sqlcode == 0) {
                        EXEC SQL COMMIT;
                        printf("[성공] %ld원이 정상적으로 출금되었습니다.\n", amount);
                    } else {
                        EXEC SQL ROLLBACK;
                        printf("[오류] 출금 실패.\n");
                    }
                }
                break;

            default:
                printf("\n[경고] 잘못된 메뉴를 선택하셨습니다. (1~4 입력)\n");
        }
    }

    EXEC SQL COMMIT WORK RELEASE;
    return 0;
}